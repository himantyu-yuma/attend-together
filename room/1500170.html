<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>計画科学</title>
    <link href="https://unpkg.com/ress/dist/ress.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Noto+Sans+JP" rel="stylesheet">
    <style>
        body {
            font-family: "Noto Sans JP";
            font-weight: normal;
            color: #443E3A;
        }

        /* チャット欄と動画があるセクション */
        section#content {
            display: flex;
            justify-content: center;
            align-items: baseline;
        }

        /* チャットのタイトル */
        div.chat>h2 {
            font-size: medium;
        }

        /* チャット本体 */
        div.msg-box {
            border: 1px solid #443E3A;
            width: 20vw;
            height: 360px;
        }

        /* 講義のメディア */
        div.class {
            text-align: center;
            margin-right: 3vw;
            margin-left: 3vw;
        }

        /* テーブル横1列 */
        div.table-row {
            margin-top: 3rem;
            display: flex;
            justify-content: center;
        }

        /* テーブル本体 */
        div.table {
            display: flex;
            align-items: center;
            width: 27vw;
            height: 6vw;
            margin-left: 2.5vw;
            margin-right: 2.5vw;
            padding-right: .5vw;
            padding-left: .5vw;
            background-color: slategray;
        }

        /* 参加者 */
        div.student {
            width: 6vw;
            text-align: center;
            margin-left: .25vw;
            margin-right: .25vw;
            position: relative;
        }

        /* 参加者のアイコン */
        img.icon {
            height: 4vw;
            width: 4vw;
            border: 4px solid #4EC5B4;
            border-radius: 50%;
        }

        /* 自分は枠線の色変える */
        #me>img.icon {
            border-color: #F99741;
        }

        #me>p.name-card {
            background-color: #F99741;
        }

        /* 参加者の名札 */
        p.name-card {
            font-size: small;
            text-align: center;
            color: white;
            background-color: #4EC5B4;
            width: 6vw;
            border-radius: 25px;
        }

        /* 音量調整用UI */
        div.volume {
            width: 7vw;
            height: 1.5vw;
            background-color: white;
            border: 1px solid #443E3A;
            border-radius: 25px;
            position: absolute;
            top: -2vw;
            right: -2vw;

            display: flex;
            align-content: center;
            justify-content: center;

            transform: rotate(-90deg);
        }

        /* スピーカーのアイコン */
        div.volume>img {
            transform: rotate(90deg);
            width: 10%;
        }

        /* レンジスライダー */
        div.volume>input {
            width: 80%;
        }

        .hidden {
            visibility: hidden;
        }
    </style>
</head>

<body>
    <section id="content">
        <div class="chat" id="public-chat">
            <h2>パブリックチャット</h2>
            <div class="msg-box">

            </div>
        </div>

        <div class="class">
            <h2>計画科学I</h2>
            <iframe id="media" width="640" height="360" src="https://www.youtube.com/embed/YtaDDCX_V7o" frameborder="0"
                allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture"
                allowfullscreen></iframe>
        </div>

        <div class="chat" id="table-chat">
            <h2>テーブルチャット</h2>
            <div class="msg-box">

            </div>
        </div>
    </section>

    <section id="room">
        <div class="table-row">
            <div class="table">

                <div class="student" id="me">
                    <img src="https://picsum.photos/200/200" alt="ユーザーアイコン" width="50" height="50" class="icon">
                    <p class="name-card">♰漆黒の堕天使♰</p>
                    <div class="volume hidden">
                        <img src="/img/volume.svg" alt="">
                        <input type="range" name="volume" min="0.0" max="1.0" step="0.01">
                        <audio src="/sample.mp3" autoplay></audio>
                    </div>
                </div>

                <div class="student">
                    <img src="https://picsum.photos/200/200" alt="ユーザーアイコン" width="50" height="50" class="icon">
                    <p class="name-card">♰漆黒の堕天使♰</p>
                    <div class="volume hidden">
                        <img src="/img/volume.svg" alt="">
                        <input type="range" name="volume" min="0.0" max="1.0" step="0.01">
                        <audio src="/sample.mp3" autoplay></audio>

                    </div>
                </div>
                <div class="student">
                    <img src="https://picsum.photos/200/200" alt="ユーザーアイコン" width="50" height="50" class="icon">
                    <p class="name-card">♰漆黒の堕天使♰</p>
                    <div class="volume hidden">
                        <img src="/img/volume.svg" alt="">
                        <input type="range" name="volume" min="0.0" max="1.0" step="0.01">
                        <audio src="/sample.mp3" autoplay></audio>

                    </div>
                </div>
                <div class="student">
                    <img src="https://picsum.photos/200/200" alt="ユーザーアイコン" width="50" height="50" class="icon">
                    <p class="name-card">♰漆黒の堕天使♰</p>
                    <div class="volume hidden">
                        <img src="/img/volume.svg" alt="">
                        <input type="range" name="volume" min="0.0" max="1.0" step="0.01">
                        <audio src="/sample.mp3" autoplay></audio>

                    </div>
                </div>
            </div>
            <div class="table">

            </div>
            <div class="table">

            </div>
        </div>
        <div class="table-row">
            <div class="table">

            </div>
            <div class="table">

            </div>
            <div class="table">

            </div>
        </div>
        <div class="table-row">
            <div class="table">

            </div>
            <div class="table">

            </div>
            <div class="table">

            </div>
        </div>
    </section>

    <template id="student-template">
        <div class="student">
            <img src="https://picsum.photos/200/200" alt="ユーザーアイコン" width="50" height="50" class="icon">
            <p class="name-card"></p>
            <div class="volume hidden">
                <img src="/img/volume.svg" alt="">
                <input type="range" name="volume" min="0.0" max="1.0" step="0.01">
                <audio src="/sample.mp3" autoplay></audio>
            </div>
        </div>
    </template>

    <script>
        // 参加者に各種イベント登録
        const addEvent = studentNode => {
            // 音量調整がついてるdiv要素
            const volumeDiv = studentNode.querySelector('.volume');

            // 音量調整出したり隠したりするイベント登録
            studentNode.addEventListener('mouseover', () => volumeDiv.classList.remove('hidden'));
            studentNode.addEventListener('mouseout', () => volumeDiv.classList.add('hidden'));

            // 音量調整のイベント登録
            const volumeController = volumeDiv.querySelector('input');
            const audio = volumeDiv.querySelector('audio');
            volumeController.addEventListener('input', () => audio.volume = volumeController.value);
        }
        // 全体にイベント付ける
        const students = document.querySelectorAll('.student');
        students.forEach(student => addEvent(student));

        const move = table => {
            // 子要素をはじく
            if (!table.classList.contains('table')) {
                return;
            }
            const myIcon = document.getElementById('me');

            // 移動
            table.appendChild(myIcon);
            // まず全テーブルミュート
            const otherTables = document.querySelectorAll('.table');
            otherTables.forEach(otherTable => {
                const otherStudents = otherTable.querySelectorAll('.student');
                otherStudents.forEach(otherStudent => {
                    const audio = otherStudent.querySelector('audio');
                    audio.muted = true;
                });
            });
            // 自分のテーブルだけミュート解除
            const sameTableStudents = table.querySelectorAll('.student');
            sameTableStudents.forEach(sameTableStudent => {
                const audio = sameTableStudent.querySelector('audio');
                audio.muted = false;
            });
        }

        const addMoveEvent = () => {
            const tables = document.querySelectorAll('.table');
            tables.forEach(table => {
                table.addEventListener('click', e => {
                    move(e.target);
                }, { capture: false });
            });
        }
        addMoveEvent();

        const createStudent = () => {
            // template要素からコンテンツを取得
            const content = document.querySelector('#student-template').content;
            const fragment = document.createDocumentFragment();

            // ノードを複製
            const clone = document.importNode(content, true);
            // テンプレート内の名札
            const name = clone.querySelector('p.name-card');
            name.textContent = '純白の大天使'

            // フラグメントに挿入
            fragment.appendChild(clone)

            const studentNode = fragment.querySelector('.student');
            addEvent(studentNode);

            // HTMLに挿入
            document.querySelectorAll('.table')[2].appendChild(fragment);
        }
        createStudent();

    </script>
</body>

</html>