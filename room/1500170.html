<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>計画科学</title>
    <link href="https://unpkg.com/ress/dist/ress.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Noto+Sans+JP" rel="stylesheet">
    <style>
        body {
            font-family: "Noto Sans JP";
            font-weight: normal;
            color: #443E3A;
        }

        /* チャット欄と動画があるセクション */
        section#content {
            display: flex;
            justify-content: center;
            align-items: baseline;
        }

        /* チャットのタイトル */
        div.chat>h2 {
            font-size: medium;
        }

        /* チャット本体 */
        div.msg-box {
            border: 1px solid #443E3A;
            width: 20vw;
            height: 360px;
        }

        /* 講義のメディア */
        div.class {
            text-align: center;
            margin-right: 3vw;
            margin-left: 3vw;
        }

        /* テーブル横1列 */
        div.table-row {
            margin-top: 3rem;
            display: flex;
            justify-content: center;
        }

        /* テーブル本体 */
        div.table {
            display: flex;
            align-items: center;
            width: 27vw;
            height: 6vw;
            margin-left: 2.5vw;
            margin-right: 2.5vw;
            padding-right: .5vw;
            padding-left: .5vw;
            background-color: slategray;
        }

        /* 参加者 */
        div.student {
            width: 6vw;
            text-align: center;
            margin-left: .25vw;
            margin-right: .25vw;
            position: relative;
        }

        /* 参加者のアイコン */
        img.icon {
            height: 4vw;
            width: 4vw;
            border: 4px solid #4EC5B4;
            border-radius: 50%;
        }

        /* 自分は枠線の色変える */
        .me>img.icon {
            border-color: #F99741;
        }

        .me>p.name-card {
            background-color: #F99741;
        }

        /* 参加者の名札 */
        p.name-card {
            font-size: small;
            text-align: center;
            color: white;
            background-color: #4EC5B4;
            width: 6vw;
            border-radius: 25px;
        }

        /* 音量調整用UI */
        div.volume {
            width: 7vw;
            height: 1.5vw;
            background-color: white;
            border: 1px solid #443E3A;
            border-radius: 25px;
            position: absolute;
            top: -2vw;
            right: -2vw;

            display: flex;
            align-content: center;
            justify-content: center;

            transform: rotate(-90deg);
        }

        /* スピーカーのアイコン */
        div.volume>img {
            transform: rotate(90deg);
            width: 10%;
        }

        /* レンジスライダー */
        div.volume>input {
            width: 80%;
        }

        .hidden {
            visibility: hidden;
        }

        section.entrance{
            display: flex;
            align-items: center;
            justify-content: center;
            height: 6vw;
            padding-right: .5vw;
            padding-left: .5vw;
        }
    </style>
</head>

<body>
    <section id="content">
        <div class="chat" id="public-chat">
            <h2>パブリックチャット</h2>
            <div class="msg-box">

            </div>
        </div>

        <div class="class">
            <h2>計画科学I</h2>
            <iframe id="media" width="640" height="360" src="https://www.youtube.com/embed/YtaDDCX_V7o" frameborder="0"
                allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture"
                allowfullscreen></iframe>
        </div>

        <div class="chat" id="table-chat">
            <h2>テーブルチャット</h2>
            <div class="msg-box">

            </div>
        </div>
    </section>

    <section id="room">
        <div class="table-row">
            <div class="table" id="1">



                <!-- <div class="student">
                    <img src="https://picsum.photos/200/200" alt="ユーザーアイコン" width="50" height="50" class="icon">
                    <p class="name-card">♰漆黒の堕天使♰</p>
                    <div class="volume hidden">
                        <img src="/img/volume.svg" alt="">
                        <input type="range" name="volume" min="0.0" max="1.0" step="0.01">
                        <audio src="" autoplay></audio>

                    </div>
                </div>
                <div class="student">
                    <img src="https://picsum.photos/200/200" alt="ユーザーアイコン" width="50" height="50" class="icon">
                    <p class="name-card">♰漆黒の堕天使♰</p>
                    <div class="volume hidden">
                        <img src="/img/volume.svg" alt="">
                        <input type="range" name="volume" min="0.0" max="1.0" step="0.01">
                        <audio src="" autoplay></audio>

                    </div>
                </div>
                <div class="student">
                    <img src="https://picsum.photos/200/200" alt="ユーザーアイコン" width="50" height="50" class="icon">
                    <p class="name-card">♰漆黒の堕天使♰</p>
                    <div class="volume hidden">
                        <img src="/img/volume.svg" alt="">
                        <input type="range" name="volume" min="0.0" max="1.0" step="0.01">
                        <audio src="" autoplay></audio>

                    </div>
                </div> -->
            </div>
            <div class="table" id="2">

            </div>
            <div class="table" id="3">

            </div>
        </div>
        <div class="table-row">
            <div class="table" id="4">

            </div>
            <div class="table" id="5">

            </div>
            <div class="table" id="6">

            </div>
        </div>
        <div class="table-row">
            <div class="table" id="7">

            </div>
            <div class="table" id="8">

            </div>
            <div class="table" id="9">

            </div>
        </div>
    </section>

    <section class="entrance">
        <div class="student me">
            <img src="https://picsum.photos/200/200" alt="ユーザーアイコン" width="50" height="50" class="icon">
            <p class="name-card">♰漆黒の堕天使♰</p>
        </div>
    </section>

    <template id="student-template">
        <div class="student">
            <img src="https://picsum.photos/200/200" alt="ユーザーアイコン" width="50" height="50" class="icon">
            <p class="name-card"></p>
            <div class="volume hidden">
                <img src="/img/volume.svg" alt="">
                <input type="range" name="volume" min="0.0" max="1.0" step="0.01">
                <audio src="" autoplay></audio>
            </div>
        </div>
    </template>

    <script src="https://cdn.webrtc.ecl.ntt.com/skyway-latest.js"></script>
    <script>
        // 参加者に音量関係のイベント登録
        const addEvent = studentNode => {
            // 自分にはいらないのでパス
            if (studentNode.classList.contains('me')) {
                return;
            }
            // 音量調整がついてるdiv要素
            const volumeDiv = studentNode.querySelector('.volume');

            // 音量調整出したり隠したりするイベント登録
            studentNode.addEventListener('mouseover', () => volumeDiv.classList.remove('hidden'));
            studentNode.addEventListener('mouseout', () => volumeDiv.classList.add('hidden'));

            // 音量調整のイベント登録
            const volumeController = volumeDiv.querySelector('input');
            const audio = volumeDiv.querySelector('audio');
            volumeController.addEventListener('input', () => audio.volume = volumeController.value);
        }
        // 全体にイベント付ける
        const students = document.querySelectorAll('.student');
        students.forEach(student => addEvent(student));

        // 移動する時に呼び出す関数
        const move = (table, room) => {
            // 子要素をはじく
            if (!table.classList.contains('table')) {
                return;
            }
            const myIcon = document.querySelector('.me');

            // 移動
            table.appendChild(myIcon);

            // 移動をルーム内に知らせる
            room.send(table.id);

            // まず全テーブルミュート
            const otherTables = document.querySelectorAll('.table');
            otherTables.forEach(otherTable => {
                const otherStudents = otherTable.querySelectorAll('.student');
                otherStudents.forEach(otherStudent => {
                    const audio = otherStudent.querySelector('audio');
                    audio.muted = true;
                });
            });
            // 自分のテーブルだけミュート解除
            const sameTableStudents = table.querySelectorAll('.student');
            sameTableStudents.forEach(sameTableStudent => {
                const audio = sameTableStudent.querySelector('audio');
                audio.muted = false;
            });
        }

        // 誰かが移動したときに発生するイベント
        const moved = (tableId, peerId) => {
            const target = document.getElementById(peerId);
            // 移動
            const table = document.getElementById(tableId);
            table.appendChild(target);
            // 自分のテーブルだったらミュートを外す
            const mytable = document.querySelector('.me').parentNode;
            if (table.id === mytable.id) {
                const targetAudio = target.querySelector('audio');
                targetAudio.muted = false;
            }

        }


        const createStudent = (stream, peerId) => {
            // template要素からコンテンツを取得
            const content = document.querySelector('#student-template').content;
            const fragment = document.createDocumentFragment();

            // ノードを複製
            const clone = document.importNode(content, true);
            // テンプレート内の名札
            const name = clone.querySelector('p.name-card');
            name.textContent = '純白の大天使'
            // 相手のマイク音声をセット
            const audio = clone.querySelector('audio');
            audio.srcObject = stream;
            // 入室時ミュート
            audio.muted = true;

            // フラグメントに挿入
            fragment.appendChild(clone)

            const studentNode = fragment.querySelector('.student');
            // id付与
            studentNode.id = peerId;
            // 諸々のイベントを付与
            addEvent(studentNode);

            // HTMLに挿入
            document.querySelector('.entrance').appendChild(fragment);
        }
        // createStudent();

        // 通話関係の処理
        const callFunction = () => {
            let localStream;
            let myId;
            // マイク音声取得
            navigator.mediaDevices.getUserMedia({ video: false, audio: true })
                .then(stream => {
                    // 着信時に相手にマイク音声を返せるように、グローバル変数に保存しておく
                    localStream = stream;
                }).catch(error => {
                    // 失敗時にはエラーログを出力
                    console.error('mediaDevice.getUserMedia() error:', error);
                    return;
                });
            //Peer作成
            const peer = new Peer({
                key: '486277a9-7c08-47e8-9744-be99ca20c5cc',
                debug: 3
            });
            //PeerID取得
            peer.on('open', () => {
                // document.getElementById('my-id').textContent = peer.id;
                myId = peer.id;
                makeCall();
            });

            // 発信処理
            const makeCall = () => {
                const roomName = '1500170';
                const room = peer.joinRoom(roomName, { mode: 'sfu', stream: localStream });

                // 自分の要素にIDをつける
                const me = document.querySelector('.me');
                me.id = myId;
                // 入室時は全オーディオミュート
                const allAudio = document.querySelectorAll('audio');
                allAudio.forEach(audio => audio.muted = true);

                // 移動イベントの登録
                const addMoveEvent = () => {
                    const tables = document.querySelectorAll('.table');
                    tables.forEach(table => {
                        table.addEventListener('click', e => {
                            move(e.target, room);
                        }, { capture: false });
                    });
                }
                addMoveEvent();

                room.on('stream', stream => {
                    createStudent(stream, stream.peerId);
                    console.log('stream event');
                });
                room.on('data', data => {
                    moved(data.data, data.src);
                    console.log(data);
                });
                room.on('peerLeave', peerId => {
                    const target = document.getElementById(peerId);
                    target.parentNode.removeChild(target);
                });
            };
        }
        callFunction();
    </script>
</body>

</html>